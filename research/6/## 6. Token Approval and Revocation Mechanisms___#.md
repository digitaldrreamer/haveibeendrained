<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# \#\# 6. Token Approval and Revocation Mechanisms

### Research Questions

**Approval Mechanics:**

- How does the Token Program's `Approve` instruction work?
- What is the account structure for storing delegate information?
- How do unlimited approvals work (u64::MAX)?
- What is the difference between `Approve` and `SetAuthority`?

**Revocation:**

- How does the `Revoke` instruction work?
- Can you revoke approvals for multiple tokens in a single transaction?
- What happens to pending transactions when an approval is revoked?

**Token-2022 Enhancements:**

- What are transfer hooks, and how do they affect approvals?
- What are permanent delegates in Token-2022?
- Are there any new approval-related features in Token-2022?

**Querying Approvals:**

- How do you query all current token account delegates for a wallet?
- What RPC methods are used to fetch token account data?
- How do you parse the delegate field from token account data?

**Existing Tools:**

- Does Revoke.cash support Solana, or is it EVM-only?
- Are there any Solana-specific approval revocation tools?
- What tools do Solana wallets provide for managing approvals?


### Desired Outputs

- Code examples for querying current approvals
- Step-by-step guide for revoking approvals
- List of existing Solana approval management tools
- Comparison of Token Program vs Token-2022 approval mechanisms

---

Perfect! Now I have comprehensive information to create the research output. Let me create the final report.

# Token Approval and Revocation Mechanisms on Solana

## Approval Mechanics

### How the Approve Instruction Works

The **Approve instruction** (specifically `ApproveChecked` for safety) grants a delegate account permission to transfer up to a specific amount of tokens from a token account without transferring ownership. The owner of the token account initiates the approval, and only the owner can authorize a delegate.[^1][^2]

When an approval is executed, the Token Program modifies the token account's delegate field to store both the delegate's public key and the delegated amount (up to `u64::MAX`, which represents 18,446,744,073,709,551,615 token units). Each token account can only have one active delegate at a time—creating a new approval automatically overwrites the previous delegation.[^3][^1]

### Account Structure for Storing Delegate Information

Token accounts on Solana follow a fixed 165-byte structure that includes delegate information:[^4][^5]


| Field | Offset | Size | Type | Purpose |
| :-- | :-- | :-- | :-- | :-- |
| mint | 0 | 32 bytes | Pubkey | Token mint address |
| owner | 32 | 32 bytes | Pubkey | Account owner/authority |
| amount | 64 | 8 bytes | u64 | Token balance |
| delegateOption | 72 | 4 bytes | u32 | Flag (>0 if delegate exists) |
| delegate | 76 | 32 bytes | Pubkey | Delegate's public key |
| state | 108 | 1 byte | u8 | Account state (initialized=1) |
| isNativeOption | 109 | 4 bytes | u32 | Flag for wrapped SOL |
| isNative | 113 | 8 bytes | u64 | Wrapped SOL amount |
| delegatedAmount | 121 | 8 bytes | u64 | Amount delegated |
| closeAuthorityOption | 129 | 4 bytes | u32 | Flag for close authority |
| closeAuthority | 133 | 32 bytes | Pubkey | Authority to close account |

The delegate account can transfer tokens up to the `delegatedAmount` specified in the approval. When you query the token account data with `getTokenAccountsByOwner` or `getTokenAccountsByDelegate`, this structure is parsed and presented in a readable JSON format.[^6]

### Unlimited Approvals (u64::MAX)

To grant unlimited approval (often used for DEX integrations), you set the delegated amount to $2^{64} - 1 = 18,446,744,073,709,551,615$ tokens (the maximum value for a u64). This is effectively unlimited for any practical token, since total supplies rarely approach this maximum.[^2]

```typescript
// Example: Approve maximum amount
const approveInstruction = getApproveCheckedInstruction({
  source: associatedTokenAddress,
  mint: mint.address,
  delegate: delegate.address,
  owner: feePayer,
  amount: 18446744073709551615n, // u64::MAX
  decimals: 9
});
```


### Difference Between Approve and SetAuthority

These are fundamentally different instructions with distinct purposes:[^7][^8]

**Approve Instruction:**

- Creates a **delegate** who can transfer tokens up to an approved amount
- Only affects the `delegate` field in the token account
- The original owner retains full control
- Can be revoked with the `Revoke` instruction
- Used for temporary permissions (e.g., DEX swaps, escrow)

**SetAuthority Instruction:**

- Changes or revokes permanent authorities on mints or token accounts
- Affects mint authorities: `MintTokens`, `FreezeAccount`
- Affects account authorities: `AccountOwner`, `CloseAccount`
- Transfers permanent control to a new account
- Cannot be undone once revoked (authority is set to null)
- Used for governance and permanent changes

For example, `SetAuthority` with `AccountOwner` transfers full ownership of a token account to another user. In contrast, `Approve` only allows a delegate to transfer up to a specified amount while you retain ownership.

## Revocation Mechanisms

### How the Revoke Instruction Works

The **Revoke instruction** removes all transfer permissions from the currently approved delegate by clearing the token account's delegate field entirely. Only the token account owner can revoke a delegate. Once revoked, the delegate can no longer transfer any tokens from the account.[^9]

The revocation sets both the `delegateOption` flag to 0 and clears the delegate address, returning full control to the owner:[^10][^8]

```typescript
// Example: Revoke a delegate
const revokeInstruction = getRevokeInstruction({
  source: associatedTokenAddress,
  owner: feePayer
});
```


### Revoking Multiple Token Approvals in a Single Transaction

While **Solana does not support revoking multiple specific tokens in one instruction**, you can batch multiple `Revoke` instructions into a single transaction to reduce costs and improve efficiency.[^11]

Solana transactions have size limits (approximately 1,232 bytes), so you should batch conservatively (typically 10-20 revoke instructions per transaction, depending on instruction data size):[^12][^11]

```typescript
// Batch multiple revocations
const revokeInstructions = tokenAccountAddresses.map(address => 
  getRevokeInstruction({
    source: address,
    owner: owner
  })
);

// Add all instructions to one transaction
const transaction = pipe(
  createTransactionMessage({ version: 0 }),
  (tx) => setTransactionMessageFeePayerSigner(feePayer, tx),
  (tx) => setTransactionMessageLifetimeUsingBlockhash(latestBlockhash, tx),
  (tx) => appendTransactionMessageInstructions(revokeInstructions, tx)
);
```


### Impact of Pending Transactions on Revoked Approvals

When you revoke an approval, **pending transactions referencing the revoked delegate may fail** at execution time. Solana processes transactions in chronological order by transaction signature, not by submission order.[^13][^14]

If a transaction was submitted that uses the delegate before the revocation was confirmed, that transaction will fail with an "invalid delegate" error when it attempts execution. This is a security feature—you cannot guarantee all in-flight transactions will be cancelled. Best practice is to:

1. Revoke the approval immediately
2. Wait for revocation confirmation
3. Assume any previously initiated transactions might still attempt execution

## Token-2022 Enhancements

### Transfer Hooks

Transfer Hooks are an extension in Token-2022 that allows token creators to enforce custom logic on every token transfer through a Cross Program Invocation (CPI).[^15][^16]

When a transfer hook is enabled:

- The Token-2022 program calls a custom program during transfers
- The custom program can implement royalties, whitelist checks, or other business logic
- Transfer hooks work independently from approvals but can interact with them
- The delegate must still be approved before transferring, and the transfer hook executes after the approval check

Transfer hooks **do not directly affect approvals** but add an additional verification layer.[^15]

### Permanent Delegates in Token-2022

Token-2022 introduces the **Permanent Delegate** extension, which creates a special authority with unlimited and unrestricted access to all token accounts of a given mint.[^17][^18]

A permanent delegate can:

- Transfer tokens from any account for that mint without owner approval
- Burn tokens from any account
- Perform operations that normally require the account owner's authorization
- Cannot be delegated per-account (it's set at the mint level)

This is useful for:

- Asset seizure in regulated tokens
- Recovery of misplaced tokens
- Protocol-level token management

**Security Implication:** Enabling a permanent delegate centralizes control; users must trust the permanent delegate holder. This should only be used when the additional control is acceptable to token holders.[^17]

### New Token-2022 Approval Features

Beyond permanent delegates, Token-2022 includes several extensions that enhance token functionality:[^19][^20][^18]

- **Immutable Owner**: Makes a token account's owner permanently unchangeable, preventing ownership transfer via `SetAuthority`
- **Default Account State**: New token accounts can be created in a frozen state, requiring explicit unfreezing
- **Memo Required on Transfer**: Forces every transfer to include an attached memo
- **CPI Guard**: Restricts how other programs can interact with the token via Cross Program Invocation

Token-2022 approvals work similarly to the original Token Program but support these extended features. The Token-2022 program ensures compatibility while adding flexibility through extensions.

## Querying Approvals

### How to Query Current Token Account Delegates

Use the **`getTokenAccountsByDelegate` RPC method** to find all token accounts that have approved a specific delegate.[^21][^6]

**Request:**

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "getTokenAccountsByDelegate",
  "params": [
    "4Nd1mBQtrMJVYVfKf2PJy9NZUZdTAsp7D4xWLs4gDB4T",
    {
      "programId": "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
    },
    {
      "commitment": "finalized",
      "encoding": "jsonParsed"
    }
  ]
}
```

This returns all token accounts where the specified address is the delegate, along with the delegated amounts.[^21][^6]

Alternatively, use **`getTokenAccountsByOwner`** to retrieve all token accounts owned by a wallet, which includes delegate information in the parsed response:[^22][^23]

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "getTokenAccountsByOwner",
  "params": [
    "GgPpTKg78vmzgDtP1DNn72CHAYjRdKY7AV6zgszoHCSa",
    {
      "programId": "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
    },
    {
      "encoding": "jsonParsed"
    }
  ]
}
```


### Parsing the Delegate Field from Token Account Data

When you request account data with `encoding: "jsonParsed"`, the delegate information is automatically parsed into a readable structure:[^6][^22]

```json
{
  "delegate": "delegate-pubkey-here",
  "delegatedAmount": "500000000",
  "state": "initialized",
  "tokenAmount": {
    "amount": "1000000000",
    "decimals": 6,
    "uiAmount": 1000
  }
}
```

For raw binary data, extract the delegate field from the token account structure at offset 76 (32-byte public key).[^24][^25]

**Example parsing in TypeScript:**

```typescript
const response = await connection.getTokenAccountsByOwner(
  walletAddress,
  { programId: TOKEN_PROGRAM_ID }
);

response.value.forEach(account => {
  const parsed = account.account.data.parsed.info;
  if (parsed.delegate) {
    console.log(`Delegate: ${parsed.delegate}`);
    console.log(`Delegated Amount: ${parsed.delegatedAmount}`);
  }
});
```


### RPC Methods for Querying Approvals

| Method | Purpose | Use Case |
| :-- | :-- | :-- |
| `getTokenAccountsByDelegate` | Find accounts where a wallet is the delegate | Revoke.cash use case—finding what a drainer can access |
| `getTokenAccountsByOwner` | Find accounts owned by a wallet (includes delegate info) | Users checking their own approvals |
| `getTokenAccountBalance` | Get balance of a specific token account | Verify delegation details for one account |
| `getProgramAccounts` | Advanced filtering on token accounts | Complex queries beyond mint/delegate |

Helius also provides simplified APIs for querying token information efficiently across mainnet and devnet.[^26][^27]

## Existing Tools for Approval Management

### Solana Approval Revocation Tools

| Tool | EVM Support | Solana Support | Features |
| :-- | :-- | :-- | :-- |
| **Famous Fox Federation's Revoker** | ❌ | ✅ | Revoke all approvals at once, batch revocation |
| **Revoke.cash** | ✅ (100+ chains) | ❌ | Popular on Ethereum, does not support Solana |
| **Magic Eden** | ✅ (partial) | ✅ | In-app approval revocation guide |

**Famous Fox Federation's Revoker** is the primary Solana-specific tool for managing approvals. It allows users to:[^28][^29][^30]

- View all active token approvals
- Revoke individual approvals
- Revoke all approvals in batch transactions

Access it at: https://famousfoxes.com/revoke[^30][^28]

### Solana Wallet Approval Management Features

**Phantom Wallet:**

- Shows connected apps in Settings → Connected Apps
- Allows disconnecting/revoking app permissions (note: this revokes dApp connections, not token approvals)
- Does not have native token approval revocation; users must use external tools like Famous Fox Federation's Revoker[^30]

**Magic Eden:**

- Provides educational guides on revoking approvals
- Recommends Famous Fox Federation's Revoker for Solana users
- Links users to security resources[^28]

**Solflare:**

- Shows connected dApps in wallet settings
- Allows reviewing and revoking dApp connections
- Recommends regular review of connected applications[^31]


### Best Practices for Managing Approvals

Security-conscious Solana users should:[^32][^31]

1. **Use multiple wallets** — Main wallet for high-value assets, daily wallet for transactions
2. **Test new apps with small amounts** — Don't grant approvals to unknown protocols
3. **Review approvals regularly** — Check both token approvals and dApp connections
4. **Revoke unused approvals immediately** — Don't leave unlimited approvals active
5. **Check transaction details before signing** — Verify exact amounts and recipient addresses
6. **Use hardware wallets** — Keep private keys offline, sign transactions on the device

## Implementation Guidance and Common Pitfalls

### Current State (December 2025)

- **Token Program** (original) handles standard approvals and revocations with proven security
- **Token-2022** adds extensions like permanent delegates and transfer hooks but has lower wallet support
- Most Solana tokens still use the original Token Program
- Approval revocation tools are functional but require manual action (no automatic expiration)


### Common Pitfalls to Avoid

1. **Assuming revocation cancels pending transactions** — Revoke immediately after approval grants if you don't want pending operations to execute
2. **Setting unlimited approvals unnecessarily** — Only use `u64::MAX` if truly required by the protocol
3. **Forgetting that only one delegate can be active** — A new approval overwrites the previous delegate entirely
4. **Not checking account state before revoking** — Verify the account still exists and has a delegate set
5. **Mixing up SetAuthority and Revoke** — These serve different purposes; Revoke is for delegates, SetAuthority is for permanent authorities

### Cost Considerations

- Single revoke instruction: ~5,000-10,000 compute units
- Batch of 10-15 revocations: ~1-2 SOL in fees (varies by network congestion)
- Batch of 20+ revocations: Risk exceeding 1,232-byte transaction size limit
- All RPC queries are free or have generous free tiers (Helius, Syndica, QuickNode offer free plans)

**Free resources for Solana token approval management:**

- Helius (free tier for query APIs)
- QuickNode (free tier for RPC)
- Solana public RPC (rate-limited but free)
- Famous Fox Federation's Revoker (free tool)


## Summary

Solana's approval system provides a secure, efficient mechanism for token delegation through the `Approve` and `Revoke` instructions. Key differences from Ethereum include fixed-size accounts, no expiration timestamps, and batch revocation capabilities. Token-2022 extends this with permanent delegates and transfer hooks for advanced use cases. Users should regularly monitor approvals using tools like Famous Fox Federation's Revoker and follow security best practices like testing new protocols with small amounts. Developers should batch revocations to optimize costs and avoid confusing temporary delegates (via Approve) with permanent authorities (via SetAuthority).
<span style="display:none">[^33][^34][^35][^36][^37][^38][^39][^40][^41][^42][^43][^44][^45][^46][^47][^48][^49][^50][^51][^52][^53][^54][^55][^56][^57][^58]</span>

<div align="center">⁂</div>

[^1]: https://docs.metablocks.world/guides/solana-token-program/approve-tokens/

[^2]: https://solana.com/zh/developers/cookbook/tokens/approve-token-delegate

[^3]: https://neonevm.org/blog/solanas-64-account-limit-thinking-past-the-constraint

[^4]: https://solana.com/docs/tokens/basics/approve-delegate

[^5]: https://solana.com/docs/tokens/basics/create-token-account

[^6]: https://www.helius.dev/docs/rpc/guides/gettokenaccountsbydelegate

[^7]: https://solanacookbook.com/references/token.html

[^8]: https://rareskills.io/post/spl-token

[^9]: https://solana.com/docs/tokens/basics/revoke-delegate

[^10]: https://michaelhly.com/solana-py/cookbook/token-operations/revoke-delegate/

[^11]: https://blockchain.oodles.io/dev-blog/batch-transactions-solana/

[^12]: https://www.quicknode.com/guides/solana-development/transactions/how-to-send-bulk-transactions-on-solana

[^13]: https://support.uniswap.org/hc/en-us/articles/7422909292813-My-transaction-has-been-pending-for-a-long-time-What-can-I-do

[^14]: https://www.reddit.com/r/solana/comments/1birpl1/network_congestion_pending_transaction/

[^15]: https://solana.com/developers/guides/token-extensions/transfer-hook

[^16]: https://www.quicknode.com/guides/solana-development/spl-tokens/token-2022/transfer-hooks

[^17]: https://www.youtube.com/watch?v=_lmiS_Z8MGU

[^18]: https://ackee.xyz/solana/book/latest/chapter4/token-2022/

[^19]: https://rareskills.io/post/token-2022

[^20]: https://smithii.io/en/difference-between-spl-token-and-token-2022/

[^21]: https://docs.syndica.io/platform/solana-rpc/http/getTokenAccountsByDelegate

[^22]: https://www.helius.dev/docs/rpc/guides/gettokenaccountsbyowner

[^23]: https://solana.com/docs/rpc/http/gettokenaccountsbyowner

[^24]: https://stackoverflow.com/questions/71471948/solana-parse-token-data

[^25]: https://github.com/hyperledger-solang/solang/blob/main/solana-library/spl_token.sol

[^26]: https://www.helius.dev/docs/das/get-tokens

[^27]: https://www.helius.dev/solana-token-apis

[^28]: https://help.magiceden.io/en/articles/6531936-how-to-revoke-token-approvals-on-ethereum-solana-base-polygon

[^29]: https://www.youtube.com/watch?v=X-ecUTAExX8

[^30]: https://www.reddit.com/r/solana/comments/18ft4bw/how_to_revoke_approvals_in_a_phantom_wallet/

[^31]: https://www.solflare.com/crypto-101/securing-your-solflare-crypto-wallet-best-practices/

[^32]: https://solana.com/learn/staying-safe-on-solana

[^33]: https://cryptoforinnovation.org/solana-staking-mechanics-a-step-by-step-explanation/

[^34]: https://stackoverflow.com/questions/72142148/give-another-account-ability-to-transfer-portion-of-sol-solana

[^35]: https://chainstack.com/solana-how-to-getsignaturesforaddress-1000-transaction-limit/

[^36]: https://solana.com/developers/guides/advanced/how-to-optimize-compute

[^37]: https://solana-labs.github.io/solana-program-library/token/js/functions/approve.html

[^38]: https://solana.com/tr/developers/cookbook/tokens/revoke-token-delegate

[^39]: https://revoke.cash/learn/approvals/how-to-revoke-token-approvals

[^40]: https://hexdocs.pm/solana_ex/Solana.SPL.Token.html

[^41]: https://michaelhly.com/solana-py/cookbook/token-operations/delegate-token-account/

[^42]: https://stackoverflow.com/questions/71001354/what-is-the-alternative-of-approve-in-evm-on-solana

[^43]: https://www.quicknode.com/docs/solana/getTokenAccountsByDelegate

[^44]: https://solana.com/docs/rpc/json-structures

[^45]: https://www.sec3.dev/blog/solana-programs-part-1-understanding-spl-token-mint

[^46]: https://www.ledger.com/academy/basic-basics/bull-run-security/how-ethereum-and-solana-tokens-work-approvals-permit-smart-accounts-and-eip-7702

[^47]: https://www.moonpay.com/learn/cryptocurrency/what-is-phantom-wallet

[^48]: https://neodyme.io/en/blog/token-2022

[^49]: https://github.com/pawsengineer/spl-token-2022-transfer-hook-anchor

[^50]: https://drpc.org/docs/solana-api/tokeninfo/getTokenAccountsByOwner

[^51]: https://20lab.app/tools/solana/revoke-authority/

[^52]: https://www.helius.dev/blog/a-hitchhikers-guide-to-solana-program-security

[^53]: https://www.quicknode.com/docs/solana/getTokenAccountsByOwner

[^54]: https://support.metamask.io/more-web3/learn/how-to-revoke-smart-contract-allowances-token-approvals/

[^55]: https://revoke.cash

[^56]: https://www.rapidinnovation.io/post/how-much-does-it-cost-to-create-a-solana-token

[^57]: https://solana.com/docs/tokens/basics/set-authority

[^58]: https://www.helius.dev/docs/getting-data

